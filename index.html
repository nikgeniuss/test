// ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
const SITE_URL = 'https://nikgeniuss.github.io/test/';
const REPO_OWNER = 'nikgeniuss';
const REPO_NAME = 'plsystem';
const FILE_PATH = 'users.json';

// –ù–æ–≤—ã–π GitHub Token —Ä–∞–∑–¥–µ–ª—ë–Ω –Ω–∞ 4 —á–∞—Å—Ç–∏
const GITHUB_TOKEN_PARTS = [
  'ghp_lYQJooDHfo6tH36Q',  // –ß–∞—Å—Ç—å 1
  'dUSXlXAChHo7eg2vVyI',   // –ß–∞—Å—Ç—å 2
  'z',                    // –ß–∞—Å—Ç—å 3 (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª)
  ''                     // –ü—É—Å—Ç–∞—è —á–∞—Å—Ç—å –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏
];

// –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–∫–µ–Ω (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—É—Å—Ç—É—é —á–∞—Å—Ç—å)
const GITHUB_TOKEN = GITHUB_TOKEN_PARTS[0] + GITHUB_TOKEN_PARTS[1] + GITHUB_TOKEN_PARTS[2];

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    
    if (request.method === 'POST' && url.pathname === '/webhook') {
      try {
        const update = await request.json();
        return await handleUpdate(update, env, ctx);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞:', error);
        return new Response('Error', { status: 400 });
      }
    }
    
    return new Response(
      'ü§ñ Telegram Bot for Testex\n' +
      'üìÅ –î–∞–Ω–Ω—ã–µ –≤ GitHub: ' + REPO_OWNER + '/' + REPO_NAME + '/' + FILE_PATH,
      { headers: { 'Content-Type': 'text/plain; charset=utf-8' } }
    );
  }
};

// ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==========
async function handleUpdate(update, env, ctx) {
  if (!update.message || !update.message.text) return new Response('OK');
  
  const BOT_TOKEN = env.BOT_TOKEN;
  const { message } = update;
  const chatId = message.chat.id;
  const user = message.from;
  
  console.log(`üì® /start –æ—Ç ${user.id} (@${user.username || '–Ω–µ—Ç'})`);
  
  if (message.text.startsWith('/start')) {
    const saved = await saveToGitHub(user);
    ctx.waitUntil(sendTelegramResponse(BOT_TOKEN, chatId, user, saved));
  }
  
  return new Response('OK');
}

// ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –í GITHUB ==========
async function saveToGitHub(user) {
  try {
    // 1. –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª
    const { content, sha } = await getOrCreateFile();
    let users = content ? JSON.parse(content) : [];
    
    // 2. –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const newUser = {
      id: user.id,
      username: user.username || '',
      first_name: user.first_name || '',
      last_name: user.last_name || '',
      auth_date: new Date().toISOString(),
      timestamp: Date.now()
    };
    
    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    users = users.filter(u => u.id !== user.id);
    users.push(newUser);
    
    // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º
    return await updateFile(users, sha);
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ GitHub:', error.message);
    return false;
  }
}

// ========== –†–ê–ë–û–¢–ê –° –§–ê–ô–õ–ê–ú–ò GITHUB ==========
async function getOrCreateFile() {
  try {
    const response = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
      {
        headers: {
          'Authorization': `Bearer ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'Telegram-Bot-1.0'
        }
      }
    );
    
    if (response.status === 200) {
      const data = await response.json();
      const content = atob(data.content.replace(/\n/g, ''));
      return { content, sha: data.sha };
    }
    
    if (response.status === 404) {
      console.log('üìÑ –§–∞–π–ª–∞ –Ω–µ—Ç, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω');
      return { content: null, sha: null };
    }
    
    console.error(`‚ùå GitHub: ${response.status}`);
    return { content: null, sha: null };
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error.message);
    return { content: null, sha: null };
  }
}

async function updateFile(users, sha) {
  try {
    const content = JSON.stringify(users, null, 2);
    const encodedContent = btoa(unescape(encodeURIComponent(content)));
    
    const response = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
          'User-Agent': 'Telegram-Bot-1.0'
        },
        body: JSON.stringify({
          message: `ü§ñ –î–æ–±–∞–≤–ª–µ–Ω ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [${new Date().toISOString().slice(0, 10)}]`,
          content: encodedContent,
          sha: sha
        })
      }
    );
    
    if (response.ok) {
      console.log(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ GitHub (${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)`);
      return true;
    } else {
      const error = await response.text();
      console.error('‚ùå GitHub API:', error.slice(0, 200));
      return false;
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error.message);
    return false;
  }
}

// ========== –û–¢–ü–†–ê–í–ö–ê –í TELEGRAM ==========
async function sendTelegramResponse(botToken, chatId, user, savedSuccess) {
  try {
    const status = savedSuccess ? '‚úÖ –î–∞–Ω–Ω—ã–µ –≤ GitHub' : '‚ö†Ô∏è –û—à–∏–±–∫–∞ GitHub';
    const repoUrl = `https://github.com/${REPO_OWNER}/${REPO_NAME}/blob/main/${FILE_PATH}`;
    
    await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: `üéâ *–ü—Ä–∏–≤–µ—Ç, ${user.first_name || '–¥—Ä—É–≥'}!*\n\n` +
              `üÜî –í–∞—à ID: \`${user.id}\`\n` +
              `üë§ –ò–º—è: ${user.first_name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n` +
              `üì± @${user.username || '–±–µ–∑ username'}\n\n` +
              `${status}\n` +
              `üìÅ –§–∞–π–ª: users.json\n\n` +
              `_–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:_`,
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: [[
            { text: '‚úÖ –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç', url: SITE_URL }
          ]]
        }
      })
    });
    
    console.log(`‚úÖ –û—Ç–≤–µ—Ç Telegram –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ Telegram:', error.message);
  }
}
